# ============================================================================
# ENHANCED PROXY CONFIGURATION SNIPPET - HTTP/3 OPTIMIZED
# ============================================================================
# File: /etc/nginx/snippets/proxy-common-http3.conf
# 
# Optimized for HTTP/3 backend integration:
#   - HTTP/3 context headers for backend applications
#   - Enhanced connection management for QUIC multiplexing
#   - WebSocket over HTTP/3 optimization
#   - Advanced timeout settings for HTTP/3 workloads
#   - Performance monitoring headers for HTTP/3 analytics
# 
# Usage in location blocks:
#   location /api/ {
#       proxy_pass http://upstream_name;
#       include /etc/nginx/snippets/proxy-common-http3.conf;
#   }
# ============================================================================

# ============================================================================
# PROTOCOL AND CONNECTION SETTINGS (HTTP/3 Enhanced)
# ============================================================================

# Use HTTP/1.1 for upstream connections (backend compatibility)
proxy_http_version 1.1;

# Enhanced connection management for HTTP/3 multiplexing
proxy_set_header Connection "";

# Enable keep-alive with extended settings for HTTP/3 backend pools
proxy_socket_keepalive on;

# ============================================================================
# HTTP/3 CONTEXT HEADERS (Backend Integration)
# ============================================================================

# Standard proxy headers
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# Enhanced headers for HTTP/3 context
proxy_set_header X-Forwarded-Host $host;
proxy_set_header X-Forwarded-Port $server_port;
proxy_set_header X-Forwarded-Server $host;

# HTTP/3 protocol information for backend processing
proxy_set_header X-HTTP-Version $server_protocol;
proxy_set_header X-HTTP3-Active $http3;
proxy_set_header X-QUIC-Version $quic_version;

# Request tracing and performance monitoring
proxy_set_header X-Request-ID $request_id;
proxy_set_header X-Request-Start $msec;

# Client information for HTTP/3 analytics
proxy_set_header X-Original-URI $request_uri;
proxy_set_header X-Original-Method $request_method;
proxy_set_header X-Client-IP $remote_addr;

# Connection information for HTTP/3 optimization
proxy_set_header X-Connection-Requests $connection_requests;
proxy_set_header X-SSL-Protocol $ssl_protocol;
proxy_set_header X-SSL-Cipher $ssl_cipher;

# ============================================================================
# TIMEOUT SETTINGS (HTTP/3 Workload Optimized)
# ============================================================================

# Enhanced timeouts for HTTP/3 multiplexed connections
proxy_connect_timeout 15s;      # Increased for HTTP/3 handshake
proxy_send_timeout 180s;        # Extended for HTTP/3 stream management
proxy_read_timeout 180s;        # Extended for complex HTTP/3 operations

# ============================================================================
# BUFFER SETTINGS (HTTP/3 Stream Optimized)
# ============================================================================

# Enhanced buffering for HTTP/3 multiplexed streams
proxy_buffering on;

# Optimized buffer configuration for HTTP/3 concurrent streams
proxy_buffer_size 32k;          # Larger for HTTP/3 headers
proxy_buffers 32 32k;          # More buffers for multiplexing
proxy_busy_buffers_size 64k;   # Larger busy buffer for HTTP/3

# ============================================================================
# ADVANCED PROXY SETTINGS (HTTP/3 Enhanced)
# ============================================================================

# Disable proxy redirect modification (maintain HTTP/3 context)
proxy_redirect off;

# Enhanced keep-alive for HTTP/3 backend connections
proxy_socket_keepalive on;

# Request body handling optimized for HTTP/3
proxy_request_buffering on;

# HTTP/3 stream management
proxy_max_temp_file_size 2048m;  # Larger for HTTP/3 multiplexing

# ============================================================================
# SECURITY HEADERS (Backend Communication)
# ============================================================================

# Remove sensitive server information from backend responses
proxy_hide_header Server;
proxy_hide_header X-Powered-By;
proxy_hide_header X-AspNet-Version;

# Add security context for backend processing
proxy_set_header X-Secure-Transport "HTTPS-HTTP3";
proxy_set_header X-TLS-Version $ssl_protocol;

# ============================================================================
# ERROR HANDLING (HTTP/3 Optimized)
# ============================================================================

# Enhanced upstream failure handling for HTTP/3 high availability
proxy_next_upstream error timeout http_502 http_503 http_504;
proxy_next_upstream_tries 3;
proxy_next_upstream_timeout 45s;

# ============================================================================
# COMPRESSION HANDLING (HTTP/3 Compatible)
# ============================================================================

# Pass through compression headers with HTTP/3 context
proxy_set_header Accept-Encoding $http_accept_encoding;

# HTTP/3 compression hints for backend
proxy_set_header X-Compression-Available "gzip, br";

# ============================================================================
# WEBSOCKET OVER HTTP/3 SPECIFIC SETTINGS
# ============================================================================

# WebSocket upgrade headers (when used in WebSocket locations)
# proxy_set_header Upgrade $http_upgrade;
# proxy_set_header Connection $connection_upgrade;

# WebSocket over HTTP/3 optimization headers
# proxy_set_header X-WebSocket-Transport "HTTP3";
# proxy_set_header Sec-WebSocket-Extensions "permessage-deflate; client_max_window_bits=15";

# ============================================================================
# DJANGO 5.2 SPECIFIC OPTIMIZATIONS
# ============================================================================

# Django CSRF and session handling with HTTP/3 context
proxy_cookie_path / "/; Secure; HttpOnly; SameSite=Strict";

# Django internationalization support
proxy_set_header Accept-Language $http_accept_language;

# Django async view optimization headers
proxy_set_header X-Async-Capable "true";
proxy_set_header X-HTTP3-Streams $http3;

# ============================================================================
# PERFORMANCE MONITORING (HTTP/3 Analytics)
# ============================================================================

# Performance timing headers for backend analytics
proxy_set_header X-Request-Start-Time $msec;
proxy_set_header X-Connection-Serial $connection;

# HTTP/3 performance metrics
proxy_set_header X-Protocol-Efficiency $http3;
proxy_set_header X-Multiplexing-Active $http3;

# ============================================================================
# REAL-TIME FEATURES (HTTP/3 Enhanced)
# ============================================================================

# Server-Sent Events over HTTP/3 optimization
# proxy_set_header X-SSE-Transport "HTTP3";
# proxy_set_header Cache-Control "no-cache";

# Real-time data streaming headers
# proxy_set_header X-Real-Time-Transport "HTTP3-QUIC";

# ============================================================================
# MOBILE OPTIMIZATION (HTTP/3 Benefits)
# ============================================================================

# Mobile device detection for HTTP/3 optimization
proxy_set_header X-Mobile-Optimized $http3;
proxy_set_header X-Network-Type "HTTP3-QUIC";

# Connection migration support headers
proxy_set_header X-Connection-Migration-Ready $http3;

# ============================================================================
# EMERGENCY SYSTEM OPTIMIZATION (Panic Platform)
# ============================================================================

# Emergency response priority headers
# proxy_set_header X-Emergency-Priority "HIGH";
# proxy_set_header X-HTTP3-Emergency-Ready $http3;

# Network reliability headers for emergency services
# proxy_set_header X-Network-Reliability "HTTP3-ENHANCED";

# ============================================================================
# CONDITIONAL SETTINGS (Location-Specific Overrides)
# ============================================================================

# These settings can be overridden in specific location blocks:

# For Server-Sent Events (disable buffering):
#   proxy_buffering off;
#   proxy_cache off;
#   proxy_read_timeout 24h;
#   proxy_send_timeout 24h;

# For WebSocket connections (upgrade headers):
#   proxy_set_header Upgrade $http_upgrade;
#   proxy_set_header Connection $connection_upgrade;
#   proxy_read_timeout 24h;
#   proxy_send_timeout 24h;

# For API endpoints with caching:
#   proxy_cache api_cache;
#   proxy_cache_valid 200 10m;
#   proxy_cache_key "$scheme$request_method$host$request_uri$http3";

# For health checks (fast timeouts):
#   proxy_connect_timeout 2s;
#   proxy_read_timeout 5s;
#   proxy_send_timeout 5s;

# For file uploads (extended timeouts):
#   proxy_connect_timeout 30s;
#   proxy_read_timeout 300s;
#   proxy_send_timeout 300s;
#   proxy_request_buffering off;

# ============================================================================
# HTTP/3 LOAD BALANCING OPTIMIZATION
# ============================================================================

# Load balancer headers for HTTP/3 backend selection
proxy_set_header X-Load-Balancer "HTTP3-Optimized";
proxy_set_header X-Backend-Protocol "HTTP1.1-over-HTTP3";

# Session affinity for HTTP/3 multiplexed connections
proxy_set_header X-Session-Affinity $remote_addr;

# ============================================================================
# USAGE EXAMPLES FOR HTTP/3 OPTIMIZATION
# ============================================================================

# Example 1: High-performance API endpoint
#   location /api/v1/ {
#       proxy_pass http://naboom_app;
#       include /etc/nginx/snippets/proxy-common-http3.conf;
#       
#       # HTTP/3 specific optimizations
#       proxy_cache api_cache;
#       proxy_cache_key "$scheme$request_method$host$request_uri$http3";
#       add_header X-Cache-Status $upstream_cache_status;
#   }

# Example 2: Real-time WebSocket over HTTP/3
#   location /ws/ {
#       proxy_pass http://naboom_ws;
#       include /etc/nginx/snippets/proxy-common-http3.conf;
#       
#       # WebSocket specific overrides
#       proxy_set_header Upgrade $http_upgrade;
#       proxy_set_header Connection $connection_upgrade;
#       proxy_buffering off;
#       proxy_read_timeout 24h;
#       proxy_send_timeout 24h;
#   }

# Example 3: Server-Sent Events over HTTP/3
#   location /stream/ {
#       proxy_pass http://naboom_app;
#       include /etc/nginx/snippets/proxy-common-http3.conf;
#       
#       # SSE specific overrides
#       proxy_buffering off;
#       proxy_cache off;
#       add_header X-Accel-Buffering no;
#       add_header Cache-Control "no-cache, no-store, must-revalidate";
#   }

# Example 4: Emergency system with HTTP/3 priority
#   location /panic/api/ {
#       proxy_pass http://naboom_app;
#       include /etc/nginx/snippets/proxy-common-http3.conf;
#       
#       # Emergency priority settings
#       proxy_connect_timeout 3s;
#       proxy_read_timeout 30s;
#       proxy_set_header X-Emergency-Priority "CRITICAL";
#       proxy_set_header X-HTTP3-Emergency "true";
#   }

# ============================================================================
# PERFORMANCE BENEFITS
# ============================================================================

# This HTTP/3 optimized proxy configuration provides:
# ✓ Enhanced backend integration with HTTP/3 context
# ✓ Optimized timeouts and buffering for QUIC multiplexing
# ✓ Advanced error handling for HTTP/3 high availability
# ✓ Performance monitoring headers for HTTP/3 analytics
# ✓ WebSocket over HTTP/3 optimization support
# ✓ Mobile and emergency system enhancements
# ✓ Future-proof settings for HTTP/3 evolution

# ============================================================================
# END OF HTTP/3 OPTIMIZED PROXY CONFIGURATION
# ============================================================================