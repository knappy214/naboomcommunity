# ============================================================================
# MOSQUITTO 2.0.22 CONFIGURATION - HTTP/3 WEBSOCKET OPTIMIZED
# ============================================================================
# File: /etc/mosquitto/conf.d/naboom-http3.conf
#
# Enhanced for HTTP/3 WebSocket integration:
#   - Dual TCP + WebSocket listeners for HTTP/3 multiplexing
#   - Enhanced WebSocket performance for HTTP/3 transport
#   - Advanced authentication for HTTP/3 security context
#   - Connection migration support for HTTP/3 mobility
#   - Real-time emergency system optimization over HTTP/3
#   - Mobile device optimization for HTTP/3 connections
# ============================================================================

# ============================================================================
# GENERAL CONFIGURATION (HTTP/3 Enhanced)
# ============================================================================

# Daemon settings optimized for HTTP/3 workload
daemon true
pid_file /var/run/mosquitto/mosquitto-http3.pid

# ============================================================================
# PERSISTENCE (HTTP/3 Workload Optimized)
# ============================================================================

# Enhanced persistence for HTTP/3 connection migration
persistence true
persistence_location /var/lib/mosquitto/
persistence_file mosquitto-http3.db

# HTTP/3 optimized persistence settings
autosave_interval 30               # More frequent saves for HTTP/3 mobility
autosave_on_changes false

# Memory and message limits optimized for HTTP/3 multiplexing
memory_limit 0
message_size_limit 536870912      # 512MB for HTTP/3 large message support

# ============================================================================
# LOGGING (HTTP/3 Enhanced Analytics)
# ============================================================================

# Comprehensive logging for HTTP/3 analysis
log_dest syslog
log_dest file /var/log/mosquitto/mosquitto-http3.log

# Enhanced log types for HTTP/3 debugging
log_type error
log_type warning
log_type notice
log_type information
log_type subscribe
log_type unsubscribe
log_type websockets
log_type debug                     # Enable for HTTP/3 debugging

# HTTP/3 specific logging enhancements
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# Connection and WebSocket logging for HTTP/3
connection_messages true
websockets_log_level 1             # Enhanced WebSocket logging

# ============================================================================
# CONNECTION LIMITS (HTTP/3 Multiplexing Optimized)
# ============================================================================

# Increased limits for HTTP/3 concurrent connections
max_connections 5000               # Higher for HTTP/3 multiplexing

# Per-client limits optimized for HTTP/3 streams
max_queued_messages 2000          # More queued messages for HTTP/3
max_inflight_messages 150         # Higher for HTTP/3 parallel processing

# QoS settings for HTTP/3 reliability
upgrade_outgoing_qos false
max_queued_bytes 0

# Enhanced keepalive for HTTP/3 connection migration
keepalive_interval 45             # Shorter for HTTP/3 mobility
retry_interval 15

# Session settings for HTTP/3 connection persistence
persistent_client_expiration 14d   # Longer for HTTP/3 session management

# ============================================================================
# SECURITY (HTTP/3 Enhanced Authentication)
# ============================================================================

# Disable anonymous access for production HTTP/3
allow_anonymous false

# Authentication files
password_file /etc/mosquitto/passwd-http3
acl_file /etc/mosquitto/aclfile-http3

# HTTP/3 security enhancements
check_retain_source true
retain_available true

# Per-listener authentication (different for TCP vs WebSocket)
per_listener_settings true

# ============================================================================
# TCP LISTENER (Local Django Application)
# ============================================================================

# Primary TCP listener for Django MQTT subscriber (local only)
listener 1883 127.0.0.1
protocol mqtt
max_connections 200
socket_domain ipv4

# TCP-specific authentication
allow_anonymous false
password_file /etc/mosquitto/passwd-http3

# ============================================================================
# WEBSOCKET LISTENERS (HTTP/3 Integration)
# ============================================================================

# Primary WebSocket listener for HTTP/3 Nginx proxy
listener 8083 127.0.0.1
protocol websockets
http_dir /usr/share/mosquitto/www
max_connections 3000

# HTTP/3 WebSocket optimizations
websockets_log_level 1
websockets_headers_size 2048       # Larger headers for HTTP/3 context

# WebSocket-specific authentication
allow_anonymous false
password_file /etc/mosquitto/passwd-http3
acl_file /etc/mosquitto/aclfile-http3

# Backup WebSocket listener for high availability
listener 8084 127.0.0.1
protocol websockets
http_dir /usr/share/mosquitto/www
max_connections 2000

# Backup listener settings
websockets_log_level 1
allow_anonymous false
password_file /etc/mosquitto/passwd-http3

# ============================================================================
# MQTT 5.0 FEATURES (HTTP/3 Enhanced)
# ============================================================================

# MQTT 5.0 optimizations for HTTP/3
max_packet_size 536870912         # 512MB for HTTP/3 efficiency
receive_maximum 200               # Higher for HTTP/3 multiplexing
send_maximum 200

# Server keepalive optimized for HTTP/3
server_keepalive 45

# Topic alias support for HTTP/3 efficiency
max_topic_alias 32767

# ============================================================================
# MESSAGE HANDLING (HTTP/3 Optimized)
# ============================================================================

# Message handling optimized for HTTP/3 transport
message_size_limit 536870912
queue_qos0_messages true

# Retained message settings for HTTP/3
max_queued_messages 2000
retain_available true

# Will message configuration for HTTP/3 connection migration
max_will_delay_interval 600       # Longer for HTTP/3 mobility

# ============================================================================
# PERFORMANCE TUNING (HTTP/3 Workload)
# ============================================================================

# Store settings optimized for HTTP/3 traffic patterns
store_clean_interval 5            # More frequent cleanup for HTTP/3
sys_interval 5                    # More frequent system stats

# Connection handling for HTTP/3
connect_timeout 45                # Longer for HTTP/3 handshake

# ============================================================================
# BRIDGE CONFIGURATION (HTTP/3 External Integration)
# ============================================================================

# Example bridge for HTTP/3 external services (uncomment if needed)
# connection external_http3_bridge
# address external-mqtt-http3.example.com:443
# topic panic/external/# out 0 "" emergency/
# topic panic/commands/# in 0 "" commands/
# bridge_attempt_unsubscribe true
# bridge_protocol_version mqttv50
# username http3_bridge_user
# password http3_bridge_password
# keepalive_interval 45
# cleansession false
# start_type automatic
# restart_timeout 45
# bridge_tls_version tlsv1.3

# ============================================================================
# AUTHENTICATION PLUGINS (HTTP/3 Integration)
# ============================================================================

# HTTP authentication plugin for Nginx HTTP/3 integration
# auth_plugin /usr/lib/mosquitto_auth_plugin.so
# auth_opt_backends http
# auth_opt_http_hostname 127.0.0.1
# auth_opt_http_port 8001
# auth_opt_http_getuser_uri /api/auth/mqtt/user
# auth_opt_http_superuser_uri /api/auth/mqtt/superuser
# auth_opt_http_aclcheck_uri /api/auth/mqtt/acl
# auth_opt_http_with_tls false
# auth_opt_http_timeout 10
# auth_opt_http_retry_count 3

# ============================================================================
# WEBSOCKET HEADERS (HTTP/3 Context)
# ============================================================================

# Custom WebSocket headers for HTTP/3 context
# These would be set by Nginx proxy:
# X-HTTP3-Transport: enabled
# X-Real-IP: client_ip
# X-Forwarded-For: proxy_chain
# X-Forwarded-Proto: https

# ============================================================================
# TOPIC PATTERNS (Emergency System Optimized)
# ============================================================================

# Topic patterns optimized for HTTP/3 emergency response:
# panic/emergency/+/sms          - SMS alerts via HTTP/3
# panic/emergency/+/call         - Voice call triggers via HTTP/3
# panic/emergency/+/location     - GPS coordinates via HTTP/3
# panic/ingest/+/device          - Device data ingestion via HTTP/3
# panic/vehicle/+/tracking       - Vehicle tracking via HTTP/3
# panic/command/+/response       - Command responses via HTTP/3

# ============================================================================
# TLS CONFIGURATION (Future HTTP/3 Direct TLS)
# ============================================================================

# TLS settings for future direct HTTP/3 MQTT (currently proxied by Nginx)
# listener 8883 0.0.0.0
# protocol mqtt
# cafile /etc/mosquitto/ca_certificates/ca.crt
# certfile /etc/mosquitto/certs/server.crt
# keyfile /etc/mosquitto/certs/server.key
# tls_version tlsv1.3
# ciphers ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
# require_certificate false
# use_identity_as_username false

# ============================================================================
# SYSTEM INTEGRATION (HTTP/3 Monitoring)
# ============================================================================

# System topics for HTTP/3 monitoring
sys_interval 5

# $SYS topics published:
# $SYS/broker/version                    - Mosquitto version
# $SYS/broker/connections/maximum        - Max connections
# $SYS/broker/connections/total          - Total connections
# $SYS/broker/messages/received          - Messages received via HTTP/3
# $SYS/broker/messages/sent              - Messages sent via HTTP/3
# $SYS/broker/subscriptions/count        - Active subscriptions
# $SYS/broker/clients/connected          - Connected clients
# $SYS/broker/clients/disconnected       - Disconnected clients
# $SYS/broker/bytes/received             - Bytes received
# $SYS/broker/bytes/sent                 - Bytes sent

# ============================================================================
# ERROR HANDLING (HTTP/3 Recovery)
# ============================================================================

# Enhanced error handling for HTTP/3 connection migration
restart_timeout 15
max_inflight_messages 150

# Connection recovery for HTTP/3 mobility
allow_duplicate_messages false

# ============================================================================
# RESOURCE LIMITS (HTTP/3 Workload)
# ============================================================================

# Memory and connection limits for HTTP/3
max_connections 5000
max_queued_messages 2000
message_size_limit 536870912

# ============================================================================
# DEVELOPMENT vs PRODUCTION (HTTP/3 Context)
# ============================================================================

# Production settings (ensure these are active)
log_type error
log_type warning
log_type notice

# Development settings (comment out in production)
# log_type debug
# log_type subscribe  
# log_type unsubscribe

# ============================================================================
# HTTP/3 SPECIFIC OPTIMIZATIONS
# ============================================================================

# Connection settings optimized for HTTP/3 transport:
# - Shorter keepalive for connection migration support
# - Larger message sizes for HTTP/3 multiplexing efficiency  
# - Enhanced WebSocket configuration for Nginx HTTP/3 proxy
# - Increased connection limits for HTTP/3 concurrent streams
# - Advanced logging for HTTP/3 performance analysis

# WebSocket over HTTP/3 benefits:
# - Connection migration (WiFi <-> mobile seamlessly)
# - Multiplexing efficiency (multiple MQTT streams over single HTTP/3 connection)
# - Better mobile performance (QUIC congestion control)
# - Enhanced security (TLS 1.3 with 0-RTT)
# - Reduced latency (HTTP/3 vs HTTP/2 improvements)

# ============================================================================
# MAINTENANCE TASKS (HTTP/3 Specific)
# ============================================================================

# Regular maintenance for HTTP/3 MQTT deployment:
# 1. Monitor WebSocket connection counts via $SYS topics
# 2. Check HTTP/3 transport efficiency via Nginx logs  
# 3. Verify connection migration functionality
# 4. Monitor emergency topic latency over HTTP/3
# 5. Check mobile client performance metrics
# 6. Update ACL for new HTTP/3 authenticated clients
# 7. Backup persistence file and configuration
# 8. Monitor memory usage with increased HTTP/3 connections

# ============================================================================
# END OF MOSQUITTO 2.0.22 + HTTP/3 CONFIGURATION
# ============================================================================