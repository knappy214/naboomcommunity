# ============================================================================
# NGINX 1.24.0 OPTIMIZED CONFIGURATION - Updated for Version-Specific Features
# ============================================================================
# File: /etc/nginx/sites-available/naboomneighbornet.net.za
# 
# Updated for:
#   - Nginx 1.24.0 HTTP/3 support
#   - Python 3.12.3 application paths
#   - Django 5.2 async capabilities
#   - Redis 8.2.2 connection optimizations
#   - Enhanced security for 2025
# ============================================================================

# ============================================================================
# UPSTREAM DEFINITIONS (Updated for Version-Specific Optimizations)
# ============================================================================

# Gunicorn with load balancing (Django 5.2 async support)
upstream naboom_app {
    least_conn;
    server 127.0.0.1:8001 max_fails=3 fail_timeout=30s weight=3;
    server 127.0.0.1:8002 max_fails=3 fail_timeout=30s weight=1 backup;
    keepalive 64;           # Increased for Django 5.2 async
    keepalive_requests 1000; # Higher for Python 3.12.3 performance
    keepalive_timeout 75s;
}

# Daphne/ASGI with session affinity (Channels 4.0 + Redis 8.2.2)
upstream naboom_ws {
    ip_hash;  # WebSocket session affinity
    server 127.0.0.1:9000 max_fails=2 fail_timeout=30s;
    server 127.0.0.1:9001 max_fails=2 fail_timeout=30s backup;
    keepalive 128;          # More connections for WebSocket
    keepalive_timeout 300s; # Longer timeout for persistent connections
}

# Mosquitto 2.0.22 with enhanced features
upstream mosquitto_ws {
    server 127.0.0.1:8083 max_fails=2 fail_timeout=15s;
    keepalive 32;
    keepalive_timeout 60s;
}

# ============================================================================
# NGINX 1.24.0 SPECIFIC RATE LIMITING (Enhanced Algorithms)
# ============================================================================

# Enhanced rate limiting with Nginx 1.24.0 features
limit_req_zone $binary_remote_addr zone=api_general:20m rate=150r/m sync;
limit_req_zone $binary_remote_addr zone=panic_api:25m rate=400r/m sync;
limit_req_zone $binary_remote_addr zone=vehicle_track:15m rate=90r/m sync;
limit_req_zone $binary_remote_addr zone=admin_login:10m rate=12r/m sync;
limit_req_zone $binary_remote_addr zone=push_reg:10m rate=40r/m sync;

# Geographic rate limiting (Nginx 1.24.0 geo module)
geo $rate_limit_key {
    default $binary_remote_addr;
    127.0.0.1 "";           # No rate limiting for localhost
    10.0.0.0/8 "";          # No rate limiting for internal network
}

limit_req_zone $rate_limit_key zone=geo_api:20m rate=200r/m sync;

# ============================================================================
# CONNECTION LIMITING (Nginx 1.24.0 Enhancements)
# ============================================================================

limit_conn_zone $binary_remote_addr zone=ws_conn:30m;
limit_conn_zone $binary_remote_addr zone=mqtt_conn:20m;
limit_conn_zone $binary_remote_addr zone=general_conn:25m;
limit_conn_zone $server_name zone=perserver_conn:10m;

# ============================================================================
# NGINX 1.24.0 ADVANCED MAPPINGS
# ============================================================================

# WebSocket upgrade mapping with fallback
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
    websocket upgrade;
}

# HTTP/3 Alt-Svc header mapping
map $ssl_preread_protocol $alt_svc {
    ""      'h3=":443"; ma=86400, h2=":443"; ma=86400';
    default 'h3=":443"; ma=86400';
}

# Dynamic CSP based on request path (enhanced for Django 5.2)
map $request_uri $csp_header {
    ~^/admin/     "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss://naboomneighbornet.net.za ws://naboomneighbornet.net.za; img-src 'self' data: blob:";
    ~^/ws/        "default-src 'self'; connect-src 'self' wss://naboomneighbornet.net.za ws://naboomneighbornet.net.za";
    ~^/api/       "default-src 'self'; connect-src 'self' https://naboomneighbornet.net.za";
    default       "default-src 'self'; img-src 'self' data: blob: https://*.gravatar.com; font-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss://naboomneighbornet.net.za; frame-ancestors 'none'; upgrade-insecure-requests;";
}

# ============================================================================
# HTTP TO HTTPS REDIRECT (Enhanced)
# ============================================================================

server {
    listen 80;
    listen [::]:80;
    server_name naboomneighbornet.net.za www.naboomneighbornet.net.za;

    # Enhanced security headers even for HTTP
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Rate limiting for HTTP requests
    limit_req zone=api_general burst=20 nodelay;

    # ACME Challenge with enhanced security
    location ^~ /.well-known/acme-challenge/ {
        alias /var/www/_letsencrypt/;
        default_type text/plain;
        try_files $uri =404;
        add_header Cache-Control "no-cache" always;
    }

    # Redirect with security headers
    location / {
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        return 301 https://$host$request_uri;
    }
}

# ============================================================================
# MAIN HTTPS SERVER (Nginx 1.24.0 + HTTP/3)
# ============================================================================

server {
    # HTTP/2 listeners
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    # HTTP/3 listeners (Nginx 1.24.0 feature)
    listen 443 quic reuseport;
    listen [::]:443 quic reuseport;

    server_name naboomneighbornet.net.za www.naboomneighbornet.net.za;

    # Connection limits
    limit_conn general_conn 200;
    limit_conn perserver_conn 1000;

    # ========================================================================
    # TLS 1.3 + HTTP/3 CONFIGURATION (Nginx 1.24.0)
    # ========================================================================
    
    ssl_certificate     /etc/letsencrypt/live/naboomneighbornet.net.za/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/naboomneighbornet.net.za/privkey.pem;

    # Modern TLS configuration (2025 standards)
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
    ssl_prefer_server_ciphers off;
    
    # TLS 1.3 0-RTT (early data) support
    ssl_early_data on;
    
    # Enhanced session management
    ssl_session_timeout 1d;
    ssl_session_cache shared:NaboomSSL:100m;  # Increased for production
    ssl_session_tickets off;

    # OCSP stapling with must-staple
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/naboomneighbornet.net.za/chain.pem;
    resolver 1.1.1.1 8.8.8.8 [2606:4700:4700::1111] [2001:4860:4860::8888] valid=300s;
    resolver_timeout 10s;

    # HTTP/3 Alt-Svc advertisement
    add_header Alt-Svc $alt_svc always;
    
    # QUIC transport parameters
    quic_retry on;
    quic_gso on;

    # ========================================================================
    # 2025 SECURITY HEADERS (Enhanced)
    # ========================================================================
    
    # HSTS with preload (2 years)
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # Frame protection
    add_header X-Frame-Options "DENY" always;
    
    # MIME sniffing protection
    add_header X-Content-Type-Options "nosniff" always;
    
    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Enhanced Permissions Policy (2025 update)
    add_header Permissions-Policy "geolocation=(self), microphone=(), camera=(), payment=(), usb=(), bluetooth=(), accelerometer=(), gyroscope=(), magnetometer=()" always;
    
    # Content Security Policy (dynamic)
    add_header Content-Security-Policy $csp_header always;
    
    # Cross-Origin policies (2025 standards)
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-site" always;
    add_header Cross-Origin-Embedder-Policy "credentialless" always;

    # ========================================================================
    # CLIENT SETTINGS (Optimized for Modern Traffic)
    # ========================================================================
    
    client_max_body_size 200M;  # Increased for modern file uploads
    client_body_timeout 120s;   # Increased for large uploads
    client_header_timeout 60s;
    client_body_buffer_size 512k;
    large_client_header_buffers 8 32k;  # Larger for complex headers

    # ========================================================================
    # COMPRESSION (Nginx 1.24.0 Enhanced)
    # ========================================================================
    
    # Brotli compression (preferred over gzip)
    brotli on;
    brotli_comp_level 6;
    brotli_min_length 1000;
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml
        application/wasm;

    # Gzip fallback for older clients
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # ========================================================================
    # LOGGING (Enhanced for Monitoring)
    # ========================================================================
    
    # Advanced log format with HTTP/3 and timing
    log_format enhanced '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'rt=$request_time uct="$upstream_connect_time" '
                       'uht="$upstream_header_time" urt="$upstream_response_time" '
                       'h3=$http3 ssl_protocol=$ssl_protocol '
                       'ssl_cipher=$ssl_cipher bytes_sent=$bytes_sent';

    access_log /var/log/naboom/nginx/access.log enhanced buffer=64k flush=5s;
    error_log /var/log/naboom/nginx/error.log warn;

    # ========================================================================
    # STATIC FILES (HTTP/3 Optimized)
    # ========================================================================
    
    location /static/ {
        alias /var/www/naboomcommunity/collected-static/;
        
        # HTTP/3 server push for critical resources
        location ~* \.(css|js)$ {
            # Try HTTP/3 push first, fallback to HTTP/2
            add_header Link "</static/css/main.css>; rel=preload; as=style, </static/js/main.js>; rel=preload; as=script" always;
            
            expires 1y;
            add_header Cache-Control "public, immutable" always;
            access_log off;
            
            # Security for static assets
            add_header X-Content-Type-Options "nosniff" always;
        }
        
        # Font files with CORS
        location ~* \.(woff2|woff|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable" always;
            add_header Access-Control-Allow-Origin "*" always;
            add_header Vary "Origin" always;
            access_log off;
        }
        
        # Images with optimization headers
        location ~* \.(png|jpg|jpeg|gif|webp|svg|avif|ico)$ {
            expires 6M;
            add_header Cache-Control "public" always;
            add_header Vary "Accept, Accept-Encoding" always;
            access_log off;
            
            # Modern image format support
            location ~* \.avif$ {
                add_header Cache-Control "public, max-age=31536000" always;
            }
        }
        
        # Default static handling
        expires 30d;
        add_header Cache-Control "public" always;
        add_header X-Content-Type-Options "nosniff" always;
        
        # Optimized file serving
        sendfile on;
        sendfile_max_chunk 1m;
        tcp_nopush on;
        tcp_nodelay on;
        access_log off;
    }

    # ========================================================================
    # HEALTH CHECKS (Enhanced for Python 3.12.3)
    # ========================================================================
    
    # Quick health check
    location = /health {
        limit_req zone=api_general burst=20 nodelay;
        
        proxy_pass http://naboom_app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Fast health check timeouts
        proxy_connect_timeout 1s;
        proxy_send_timeout 1s;
        proxy_read_timeout 1s;
        
        access_log off;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }
    
    # Detailed health check (monitoring systems)
    location = /health/detailed {
        limit_req zone=api_general burst=5 nodelay;
        
        # Restrict access
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
        
        proxy_pass http://naboom_app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
        
        access_log off;
    }

    # ========================================================================
    # PANIC SYSTEM (Emergency Response - High Priority)
    # ========================================================================
    
    # Panic API with geographic awareness
    location /panic/api/ {
        limit_req zone=panic_api burst=150 nodelay;
        limit_req_status 429;
        
        # Priority routing
        proxy_pass http://naboom_app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # Enhanced timeouts for emergency system
        proxy_connect_timeout 3s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # Retry logic for high availability
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;
        
        # Optimized buffering
        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 32 16k;
        proxy_busy_buffers_size 64k;
    }
    
    # Server-Sent Events (Real-time streams)
    location = /panic/api/stream {
        limit_req zone=panic_api burst=30 nodelay;
        
        proxy_pass http://naboom_app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE optimizations
        proxy_connect_timeout 5s;
        proxy_send_timeout 24h;
        proxy_read_timeout 24h;
        
        # Critical: Complete buffering disable for SSE
        proxy_buffering off;
        proxy_cache off;
        proxy_max_temp_file_size 0;
        add_header X-Accel-Buffering no;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Chunked transfer
        chunked_transfer_encoding on;
        
        # Keep connection alive
        proxy_set_header Connection "keep-alive";
    }

    # ========================================================================
    # WEBSOCKET (Enhanced for Channels 4.0 + Redis 8.2.2)
    # ========================================================================
    
    location /ws/ {
        limit_conn ws_conn 2000;  # Increased for production
        limit_req zone=geo_api burst=100 nodelay;
        
        # WebSocket authentication
        access_by_lua_block {
            -- Optional: Add WebSocket authentication logic here
        }
        
        proxy_pass http://naboom_ws;
        proxy_http_version 1.1;
        
        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # WebSocket optimizations for Django Channels 4.0
        proxy_connect_timeout 60s;
        proxy_send_timeout 24h;
        proxy_read_timeout 24h;
        proxy_socket_keepalive on;
        
        # No buffering for WebSocket
        proxy_buffering off;
        proxy_redirect off;
        
        # TCP optimizations
        tcp_nodelay on;
        
        # WebSocket-specific headers
        proxy_set_header Sec-WebSocket-Extensions "permessage-deflate; client_max_window_bits";
        proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;
    }

    # ========================================================================
    # MQTT OVER WEBSOCKET (Mosquitto 2.0.22)
    # ========================================================================
    
    location /mqtt {
        limit_conn mqtt_conn 1000;
        limit_req zone=panic_api burst=50 nodelay;
        
        # MQTT device authentication
        auth_request /auth/mqtt-device;
        auth_request_set $auth_user $upstream_http_x_auth_user;
        auth_request_set $auth_device $upstream_http_x_auth_device;
        
        proxy_pass http://mosquitto_ws;
        proxy_http_version 1.1;
        
        # WebSocket upgrade for MQTT
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass authentication info to Mosquitto
        proxy_set_header X-Auth-User $auth_user;
        proxy_set_header X-Auth-Device $auth_device;
        
        # MQTT connection settings
        proxy_connect_timeout 30s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
        
        # No buffering for MQTT
        proxy_buffering off;
        tcp_nodelay on;
        
        # MQTT keep-alive handling
        proxy_socket_keepalive on;
    }
    
    # MQTT device authentication endpoint
    location = /auth/mqtt-device {
        internal;
        proxy_pass http://naboom_app/api/auth/mqtt-device;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ========================================================================
    # API ENDPOINTS (Django 5.2 Optimized)
    # ========================================================================
    
    location /api/ {
        limit_req zone=geo_api burst=100 nodelay;
        
        proxy_pass http://naboom_app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # Optimized for Django 5.2 async views
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Enhanced buffering for API responses
        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 32 16k;
        
        # API response caching
        location ~ ^/api/(v1|v2)/(?!auth|user) {
            proxy_cache api_cache;
            proxy_cache_valid 200 10m;
            proxy_cache_valid 404 1m;
            proxy_cache_key "$scheme$request_method$host$request_uri";
            proxy_cache_bypass $http_cache_control;
            add_header X-Cache-Status $upstream_cache_status always;
        }
    }

    # ========================================================================
    # DJANGO ADMIN (Enhanced Security)
    # ========================================================================
    
    location /admin/login/ {
        limit_req zone=admin_login burst=10 nodelay;
        
        # Enhanced admin security
        # Uncomment and configure for IP restrictions:
        # allow 192.168.1.0/24;
        # allow 10.0.0.0/8;
        # deny all;
        
        proxy_pass http://naboom_app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Admin-specific timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # Additional security headers for admin
        add_header X-Frame-Options "DENY" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;
    }

    # ========================================================================
    # ROOT LOCATION (Wagtail 7.1 CMS)
    # ========================================================================
    
    location / {
        limit_req zone=geo_api burst=50 nodelay;
        
        proxy_pass http://naboom_app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # Wagtail 7.1 optimizations
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # CMS page caching
        proxy_cache cms_cache;
        proxy_cache_valid 200 15m;
        proxy_cache_valid 404 5m;
        proxy_cache_bypass $http_cache_control $cookie_sessionid;
        proxy_no_cache $http_cache_control $cookie_sessionid;
        add_header X-Cache-Status $upstream_cache_status always;
        
        # Standard proxy buffering for CMS
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 16 8k;
    }

    # ========================================================================
    # ERROR PAGES (Enhanced)
    # ========================================================================
    
    error_page 404 /404.html;
    error_page 429 /429.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        root /var/www/naboomcommunity/error_pages;
        internal;
        add_header Cache-Control "no-cache, max-age=300" always;
    }
    
    location = /429.html {
        root /var/www/naboomcommunity/error_pages;
        internal;
        add_header Cache-Control "no-cache" always;
        add_header Retry-After "120" always;
    }
    
    location = /50x.html {
        root /var/www/naboomcommunity/error_pages;
        internal;
        add_header Cache-Control "no-cache, max-age=60" always;
    }
}

# ============================================================================
# CACHE ZONES (Enhanced for Production)
# ============================================================================

# API response cache
proxy_cache_path /var/cache/nginx/api 
    levels=1:2 
    keys_zone=api_cache:50m 
    inactive=120m 
    max_size=1g 
    use_temp_path=off 
    loader_threshold=300 
    loader_sleep=200;

# CMS page cache
proxy_cache_path /var/cache/nginx/cms 
    levels=1:2 
    keys_zone=cms_cache:100m 
    inactive=60m 
    max_size=2g 
    use_temp_path=off;

# Rate limiting sync (for multiple Nginx instances)
limit_req_status 429;
limit_conn_status 503;

# ============================================================================
# GEOIP CONFIGURATION (Optional - requires GeoIP2 module)
# ============================================================================

# Uncomment if GeoIP2 module is available:
# geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
#     auto_reload 5m;
#     $geoip2_metadata_country_build metadata build_epoch;
#     $geoip2_data_country_code default=US source=$remote_addr country iso_code;
#     $geoip2_data_country_name country names en;
# }

# ============================================================================
# END OF CONFIGURATION
# ============================================================================