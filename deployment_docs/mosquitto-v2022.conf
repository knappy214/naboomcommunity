# ============================================================================
# MOSQUITTO 2.0.22 OPTIMIZED CONFIGURATION FOR NABOOM COMMUNITY
# ============================================================================
# File: /etc/mosquitto/conf.d/naboom.conf
#
# Updated for Mosquitto 2.0.22 with:
#   - Enhanced security features
#   - Performance optimizations
#   - WebSocket improvements
#   - Advanced logging and monitoring
#   - Integration with Nginx 1.24.0 reverse proxy
# ============================================================================

# ============================================================================
# GENERAL CONFIGURATION (Mosquitto 2.0.22)
# ============================================================================

# Daemon settings
daemon true
pid_file /var/run/mosquitto/mosquitto.pid

# ============================================================================
# PERSISTENCE SETTINGS (Enhanced for 2.0.22)
# ============================================================================

# Enable message persistence with optimizations
persistence true
persistence_location /var/lib/mosquitto/
persistence_file mosquitto.db

# Mosquitto 2.0.22 persistence optimizations
autosave_interval 60
autosave_on_changes false

# Memory limits for persistence
memory_limit 0
message_size_limit 268435456  # 256MB max message size

# ============================================================================
# LOGGING CONFIGURATION (Mosquitto 2.0.22 Enhanced)
# ============================================================================

# Multiple log destinations
log_dest syslog
log_dest file /var/log/mosquitto/mosquitto.log

# Enhanced log types for Mosquitto 2.0.22
log_type error
log_type warning
log_type notice
log_type information
log_type subscribe
log_type unsubscribe
log_type websockets
log_type none

# Timestamp configuration
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# Connection logging for security monitoring
connection_messages true

# ============================================================================
# CONNECTION LIMITS AND PERFORMANCE (2.0.22 Optimizations)
# ============================================================================

# Maximum concurrent connections (increased for production)
max_connections 2000

# Per-client limits
max_queued_messages 1000
max_inflight_messages 100

# QoS settings
upgrade_outgoing_qos false
max_queued_bytes 0

# Keepalive settings
keepalive_interval 60
retry_interval 20

# Session settings
persistent_client_expiration 7d

# ============================================================================
# SECURITY CONFIGURATION (Mosquitto 2.0.22 Enhanced)
# ============================================================================

# Disable anonymous access (security requirement)
allow_anonymous false

# Authentication methods
password_file /etc/mosquitto/passwd
acl_file /etc/mosquitto/aclfile

# Mosquitto 2.0.22 security enhancements
check_retain_source true
retain_available true

# TLS/SSL Configuration (if using secure connections)
# cafile /etc/mosquitto/ca_certificates/ca.crt
# certfile /etc/mosquitto/certs/server.crt
# keyfile /etc/mosquitto/certs/server.key
# tls_version tlsv1.3
# ciphers ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
# require_certificate false
# use_identity_as_username false

# ============================================================================
# TCP LISTENER (Django Application - Local Only)
# ============================================================================

# Primary TCP listener for Django MQTT subscriber
listener 1883 127.0.0.1
protocol mqtt
max_connections 100

# Socket options for local connections
socket_domain ipv4

# ============================================================================
# WEBSOCKET LISTENER (Mobile/Web Clients via Nginx Proxy)
# ============================================================================

# WebSocket listener (proxied by Nginx 1.24.0)
listener 8083 127.0.0.1
protocol websockets
http_dir /usr/share/mosquitto/www

# Mosquitto 2.0.22 WebSocket enhancements
websockets_log_level 0
websockets_headers_size 1024

# ============================================================================
# TOPIC AND MESSAGE CONFIGURATION
# ============================================================================

# Topic alias support (MQTT 5.0 feature in Mosquitto 2.0.22)
max_topic_alias 65535

# Message handling
message_size_limit 268435456  # 256MB
queue_qos0_messages true

# Retained message settings
max_queued_messages 1000
retain_available true

# ============================================================================
# AUTHENTICATION PLUGINS (Mosquitto 2.0.22)
# ============================================================================

# HTTP authentication plugin (if using external auth)
# auth_plugin /usr/lib/mosquitto_auth_plugin.so
# auth_opt_backends http
# auth_opt_http_hostname 127.0.0.1
# auth_opt_http_port 8001
# auth_opt_http_getuser_uri /api/auth/mqtt/user
# auth_opt_http_superuser_uri /api/auth/mqtt/superuser
# auth_opt_http_aclcheck_uri /api/auth/mqtt/acl

# ============================================================================
# BRIDGE CONFIGURATION (for external MQTT brokers)
# ============================================================================

# Example bridge configuration (uncomment if needed)
# connection external_bridge
# address external-mqtt-broker.example.com:1883
# topic panic/external/# out 0
# topic panic/commands/# in 0
# bridge_attempt_unsubscribe true
# bridge_protocol_version mqttv50
# username bridge_user
# password bridge_password
# keepalive_interval 60
# cleansession false
# start_type automatic
# restart_timeout 30

# ============================================================================
# WILL MESSAGE CONFIGURATION
# ============================================================================

# Last Will and Testament settings
max_will_delay_interval 300

# ============================================================================
# MQTT 5.0 FEATURES (Mosquitto 2.0.22 Support)
# ============================================================================

# MQTT 5.0 feature support
max_packet_size 268435456
receive_maximum 100
send_maximum 100

# Server keepalive
server_keepalive 60

# ============================================================================
# PERFORMANCE TUNING (Mosquitto 2.0.22)
# ============================================================================

# Store settings for better performance
store_clean_interval 10
sys_interval 10

# Connection handling optimizations
connect_timeout 30

# ============================================================================
# LOGGING AND MONITORING (Enhanced)
# ============================================================================

# Extended logging for production monitoring
log_facility 5
log_type debug      # Remove in production for performance

# Connection tracking
connection_messages true

# ============================================================================
# PLUGIN CONFIGURATION (Mosquitto 2.0.22)
# ============================================================================

# Load authentication plugin if available
# plugin /usr/lib/mosquitto_dynamic_security.so
# plugin_opt_config_file /etc/mosquitto/dynamic-security.json

# ============================================================================
# WEBSOCKET SPECIFIC CONFIGURATION
# ============================================================================

# WebSocket path (default is /)
# websockets_path /mqtt

# CORS settings for WebSocket connections
# websockets_headers_size 1024

# ============================================================================
# SYSTEM INTEGRATION SETTINGS
# ============================================================================

# User and group (security)
# user mosquitto
# group mosquitto

# ============================================================================
# DEVELOPMENT vs PRODUCTION SETTINGS
# ============================================================================

# Development settings (comment out in production)
# log_type debug
# log_type subscribe
# log_type unsubscribe

# Production settings (ensure these are active)
log_type error
log_type warning
log_type notice

# ============================================================================
# BACKUP AND RECOVERY SETTINGS
# ============================================================================

# Persistence cleanup
persistence_file mosquitto.db
store_clean_interval 10

# ============================================================================
# INTEGRATION WITH NGINX 1.24.0
# ============================================================================

# This configuration assumes:
# 1. Nginx 1.24.0 proxies WebSocket connections from port 443 to 8083
# 2. Authentication is handled by Django via Nginx auth_request
# 3. Rate limiting is applied at the Nginx level
# 4. TLS termination happens at Nginx (not at Mosquitto level)

# ============================================================================
# MONITORING AND HEALTH CHECKS
# ============================================================================

# System topics for monitoring (MQTT 5.0)
# $SYS topics are automatically published by Mosquitto 2.0.22

# Health check settings
sys_interval 10

# ============================================================================
# ERROR HANDLING AND RECOVERY
# ============================================================================

# Automatic restart settings
restart_timeout 10
max_inflight_messages 20

# ============================================================================
# RESOURCE LIMITS
# ============================================================================

# Memory and connection limits
max_connections 2000
max_queued_messages 1000
message_size_limit 268435456

# ============================================================================
# END OF CONFIGURATION
# ============================================================================

# This Mosquitto 2.0.22 configuration is optimized for:
# - Integration with Nginx 1.24.0 reverse proxy
# - High-performance WebSocket connections
# - Secure MQTT messaging for IoT devices
# - Production-grade logging and monitoring
# - Django application integration
# - Mobile and web client support

# Maintenance tasks:
# 1. Rotate log files regularly
# 2. Monitor connection counts and memory usage
# 3. Update ACL file as needed for new devices
# 4. Check persistence file size and cleanup if needed
# 5. Monitor authentication logs for security issues