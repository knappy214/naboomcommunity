{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}MQTT Service Dashboard{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .mqtt-dashboard {
        padding: 20px;
    }
    
    .status-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-healthy {
        border-left: 4px solid #28a745;
    }
    
    .status-degraded {
        border-left: 4px solid #ffc107;
    }
    
    .status-unhealthy {
        border-left: 4px solid #dc3545;
    }
    
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .metric-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    
    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #495057;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9em;
        margin-top: 5px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-healthy { background-color: #28a745; }
    .status-degraded { background-color: #ffc107; }
    .status-unhealthy { background-color: #dc3545; }
    
    .refresh-button {
        background: #007cba;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 20px;
    }
    
    .refresh-button:hover {
        background: #005a87;
    }
    
    .topics-list {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .topic-item {
        padding: 5px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .topic-item:last-child {
        border-bottom: none;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="mqtt-dashboard">
    <h1>MQTT Service Dashboard</h1>
    
    <button class="refresh-button" onclick="refreshDashboard()">ðŸ”„ Refresh</button>
    
    <div class="status-card status-{{ health_status }}">
        <h2>
            <span class="status-indicator status-{{ health_status }}"></span>
            Service Status: {{ health_status|upper }}
        </h2>
        <p><strong>Connection:</strong> 
            {% if metrics.connected %}
                <span style="color: green;">âœ“ Connected</span>
            {% else %}
                <span style="color: red;">âœ— Disconnected</span>
            {% endif %}
        </p>
        <p><strong>Uptime:</strong> {{ uptime_formatted }}</p>
        <p><strong>Last Activity:</strong> {{ time_since_activity }}</p>
    </div>
    
    <div class="metric-grid">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.messages_processed|floatformat:0 }}</div>
            <div class="metric-label">Messages Processed</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value">{{ metrics.messages_per_minute|floatformat:2 }}</div>
            <div class="metric-label">Messages/Minute</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value">{{ metrics.connection_retries }}</div>
            <div class="metric-label">Connection Retries</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-value" style="color: {% if metrics.error_count == 0 %}green{% elif metrics.error_count < 5 %}orange{% else %}red{% endif %};">
                {{ metrics.error_count }}
            </div>
            <div class="metric-label">Errors</div>
        </div>
    </div>
    
    <div class="status-card">
        <h3>Connection Details</h3>
        <p><strong>Broker:</strong> {{ metrics.broker_host }}:{{ metrics.broker_port }}</p>
        <p><strong>Client ID:</strong> {{ metrics.client_id }}</p>
        <p><strong>Keepalive:</strong> {{ metrics.keepalive }} seconds</p>
    </div>
    
    <div class="status-card">
        <h3>Subscribed Topics ({{ metrics.subscribed_topics|length }})</h3>
        <div class="topics-list">
            {% for topic in metrics.subscribed_topics %}
                <div class="topic-item">{{ topic }}</div>
            {% empty %}
                <div class="topic-item">No topics subscribed</div>
            {% endfor %}
        </div>
    </div>
    
    {% if metrics.last_error %}
    <div class="status-card">
        <h3>Last Error</h3>
        <div class="error-message">{{ metrics.last_error }}</div>
    </div>
    {% endif %}
    
    <div class="status-card">
        <h3>Quick Actions</h3>
        <p>
            <a href="{% url 'admin:mqtt_health_json' %}" target="_blank" class="button">View Health JSON</a>
            <a href="{% url 'admin:mqtt_metrics_json' %}" target="_blank" class="button">View Metrics JSON</a>
            <a href="{% url 'admin:index' %}" class="button">Back to Admin</a>
        </p>
    </div>
</div>

<script>
function refreshDashboard() {
    location.reload();
}

// Auto-refresh every 30 seconds
setInterval(function() {
    refreshDashboard();
}, 30000);
</script>
{% endblock %}
